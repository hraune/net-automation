---
# All the nodes in the network

nodes:

{% for node in nodes %}

  {{ node.name }}:
    mgmt: {{ node.mgmt }}
    loopback: {{ node.loopback }}
{##}{% set asn = false %}
{##}{% set rd = false %}
    bgp:
{##}{% for bgp in mpbgp %}
{##}{##}{% if bgp.left == node.name %}
{##}{##}{##}{% set asn = bgp.left_asn %}
      - { neighbor: {{ bgp.right }}, ip: {{ bgp.right_ip }}, asn: {{ bgp.right_asn }} }
{##}{##}{% elif bgp.right == node.name %}
{##}{##}{##}{% set asn = bgp.right_asn %}
      - { neighbor: {{ bgp.left }}, ip: {{ bgp.left_ip }}, asn: {{ bgp.left_asn }} }
{##}{##}{% endif %}
{##}{% endfor %}
{##}{% if asn != false %}
    asn: {{ asn }}
{##}{% endif %}
    interfaces:
{##}{% for pair in fabric %} 
{##}{##}{% if pair.left == node.name or pair.right == node.name %}
{##}{##}{##}{% if pair.left == node.name %}
      {{ pair.left_port }}: {{ linknet.fabric_linknets[loop.index0]|ipaddr('1') }}
{##}{##}{##}{% else %}
      {{ pair.right_port }}: {{ linknet.fabric_linknets[loop.index0]|ipaddr('2') }}
{##}{##}{##}{% endif %}
{##}{##}{##}{% if pair.left in isp_nodes and pair.right in isp_nodes %}
      ospf: {id: 1, area: 0}
{##}{##}{##}{% else  %}
{##}{##}{##}{##}{% for vpn,params in VPNV4 %}
{##}{##}{##}{##}{##}{% if params.nodes|in_list(pair.left) or params.nodes|in_list(pair.right) %}
      ospf: {id: vpn.ospfid, area: 0}
      vrf: {{ vpn }}
{##}{##}{##}{##}{##}{##}{% set rd = vpn.rd %}
{##}{##}{##}{##}{##}{% endif %}
{##}{##}{##}{##}{% endfor %}
{##}{##}{##}{% endif %}
{##}{##}{% endif %}
{##}{% endfor %}
{##}{% if rd != false %}
    rd: {{ rd }}
{##}{% endif %}
{% endfor %}