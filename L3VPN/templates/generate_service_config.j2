{%- for node in nodes if node.name == inventory_hostname %}
!
{% if node.vpn is defined %}
!
{% for vpn in node.vpn %}
ip vrf {{ vpn.name }}
 rd: {{ vpn.rd }}
 route-target export {{ vpn.rd }}
 route-target import {{ vpn.rd }}
{% endfor %}
{% endif %}
!
{% for interface in node.interfaces if interface.vrf is defined  %}
interface {{ interface.name }}
 ip vrf forwarding {{ interface.vrf }}
 ip address {{ interface.ip|ipaddr('address') }} {{ interface.ip|ipaddr('netmask') }}
 ip ospf {{ interface.ospf.id }} area {{ interface.ospf.area }}
!
{% endfor %}
!
{% if node.vpn is defined %}
{##}{% for vpn in node.vpn %}
router ospf {{ vpn.ospf.id }} vrf {{ vpn.name }}
 redistribute bgp {{ node.asn }} subnets
!
{##}{% endfor %}
{% endif %}
!
{% if node.asn is defined %}
router bgp {{ node.asn }}
{% for vpn in node.vpn %}
 address-family ipv4 vrf {{ vpn.name }}
  redistribute ospf {{ vpn.ospf.id }}
 exit-address-family
 !
{% endfor %}
{% endif %}
{% endfor %}